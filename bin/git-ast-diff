#!/bin/bash
#
# A wrapper script for ast-diff to allow its invocation by as a git
# external diff tool.  Git will pass 7 arguments to this tool,
#
#     old-file old-hex old-mode new-file new-hex new-mode
#
# where as ast-diff only wants the second and fifth arguments.
#
# To configure git to use ast-diff run the following in a repository:
#
#     git config diff.external /full/path/to/resolve/bin/git-ast-diff
#
# or run the following to configure its use globally.
#
#     git config --global diff.external /full/path/to/resolve/bin/git-ast-diff
#
# If you have configured this script as your git-diff driver, and it
# starts to act buggy, you can disable it for individual runs by
# passing the --no-ext-diff option to git-diff.
#
# NOTE: Define the environment variable GIT_AST_DIFF_DEBUG to a file
# name to collect debug output into that file.  Unset that variable to
# avoid collecting debug output.
bold=$(tput bold)
normal=$(tput sgr0)

echo "${bold}ast-diff $2 $5"
if [ "$5" == "/dev/null" ];then
  echo "${bold}deleted file mode $4"
  diff --color=always "$2" "$5"
  exit 0
elif [ "$2" == "/dev/null" ];then
  echo "${bold}created file mode $7"
  diff --color=always "$2" "$5"
  exit 0
else
  echo "${bold}index $(echo $3|cut -c -8)..$(echo $6|cut -c -8) $7"
fi

## With debugging.
if [ ! -z ${GIT_AST_DIFF_DEBUG} ];then
  echo "$@" >> "${GIT_AST_DIFF_DEBUG}"
  backup(){ cp $1 $(mktemp --suffix=".$(echo $1|sed 's/.*\.//;s|^/||;s|[^/]*/||')"); }
  backup $2
  backup $5
  ast-diff "$2" "$5"
  EXIT=$?
  echo -e "Returned $EXIT\n" >> ${GIT_AST_DIFF_DEBUG}
else
  ## Without debugging.
  ast-diff "$2" "$5"
  EXIT=$?
fi
if [ $EXIT == 1 ] || [ $EXIT == 0 ];then
  exit 0
else
  exit $EXIT
fi
