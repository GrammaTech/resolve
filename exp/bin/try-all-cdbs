#!/bin/bash
#
# Usage: try-all-cdbs [OPTION]... REPOSITORY...
#  Try to build every CDB in every REPOSITORY
#
# OPTIONS:
#   -h,--help ---------- print this help information
#   -o,--outdir DIR ---- Save results to outdir
#                        defaults to the current directory
#   -d, --docker DOCK -- Base docker images off of DOCK
#
OUTDIR=$(pwd)
SCRIPT="$0"
DOCK=
help(){
    local HELP_TEXT=$(cat "$SCRIPT" \
        |sed '/^[^#]/q' \
        |head -n -1 \
        |tail -n +3 \
        |sed -e :a -e '/^\n*$/{$d;N;ba' -e '}' \
        |cut -c3-)
    echo "$HELP_TEXT"
    exit 1
}

eval set -- $(getopt -o ho:d: -l help,outdir:,docker: -- "$@" || help;)
while [ $# -gt 0 ];do
    case $1 in
        -h|--help) help;;
        -o|--outdir) OUTDIR=$(readlink -f $2); shift;;
        -d|--docker) DOCK=$2; shift;;
        (--) shift; break;;
        (-*) error "unrecognized option $1";;
        (*)  break;;
    esac
    shift
done

if [ -z $1 ];then
    help
fi

for REPO in $@;do
  pushd $REPO
  IMAGE="$REPO-cdb"
  git checkout origin/master -- gt-harness.sh
  ./gt-harness.sh docker ${IMAGE} ${DOCK}
  docker run -v $(dirname $(readlink -f ${SCRIPT}))/try-all-cdbs-in-image-loop.sh:/try-all-cdbs-in-image-loop.sh ${OUTDIR}:/cdbs ${IMAGE} /try-all-cdbs-in-image-loop.sh
  docker rmi -f ${IMAGE}
  popd
done
