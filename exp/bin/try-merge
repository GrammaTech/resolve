#!/bin/bash
#
# Usage: try-merge REPO HASH-BASE HASH-LEFT HASH-RIGHT
#  Computes a diff of the merge from HASH-BASE to
#  HASH-LEFT and HASH-RIGHT.
#
#  REPO as the base repository holding all hashes.
#
# OPTIONS:
#   -h,--help ---------- print this help information
#   -d,--diff ---------- diff tool to use to compute patches
#                        default to diff3
#   -l,--local --------- pass the 'local' option to git clone
#   -w,--workdir ------- set the working directory
#                        defaults to the current directory
#
LOCAL=
WORKDIR=$(pwd)
DIFF=diff3
SCRIPT="$0"
help(){
    local HELP_TEXT=$(cat "$SCRIPT" \
        |sed '/^[^#]/q' \
        |head -n -1 \
        |tail -n +3 \
        |sed -e :a -e '/^\n*$/{$d;N;ba' -e '}' \
        |cut -c3-)
    echo "$HELP_TEXT"
    exit 1
}

eval set -- $(getopt -o hlw:d: -l help,local,workdir:,diff: -- "$@" || help;)
while [ $# -gt 0 ];do
    case $1 in
        -h|--help) help;;
        -l|--local) LOCAL=--local;;
        -w|--workdir) WORKDIR=$(readlink -f $2); shift;;
        -d|--diff) DIFF=$2; shift;;
        (--) shift; break;;
        (-*) error "unrecognized option $1";;
        (*)  break;;
    esac
    shift
done
if [ -z $1 ] || [ -z $2 ] || [ -z $3 ] || [ -z $4 ];then
    help
else
  REPO=$1
  NAME=$(basename $REPO .git)
  BASE=$2
  LEFT=$3
  RIGHT=$4
  shift;shift;shift;shift;
fi
DIFFNAME=$(basename ${DIFF})
RESULT_DIR=${WORKDIR}/${NAME}-${BASE}-${LEFT}-${RIGHT}

if [ ! -d  ${RESULT_DIR} ];then
  mkdir -p ${RESULT_DIR}
fi
cd $WORKDIR;

for dir in base left right;do
  if [ ! -d ${NAME}-${dir} ];then
    git clone ${LOCAL} ${REPO} ${NAME}-${dir} -q >/dev/null
  fi
done
(cd $WORKDIR/${NAME}-base; git reset --hard ${BASE} >/dev/null)
(cd $WORKDIR/${NAME}-left; git reset --hard ${LEFT} >/dev/null)
(cd $WORKDIR/${NAME}-right; git reset --hard ${RIGHT} >/dev/null)

for file in $(cd $WORKDIR/${NAME}-base;git diff --name-only $LEFT $RIGHT --); do
  mkdir -p ${RESULT_DIR}/$(dirname $file)
  if [ -f ${NAME}-base/${file} ];then
    OUT="$(${DIFF} ${NAME}-left/${file} ${NAME}-base/${file} ${NAME}-right/${file})"
    ERR=$?
    case $ERR in
      # Delete file if no conflict.
      0) echo "${OUT}" > ${RESULT_DIR}/${file}.${DIFFNAME}-patch.0;;
      # Name file if conflict.
      1) echo "${RESULT_DIR}/${file}"
         echo "${OUT}" > ${RESULT_DIR}/${file}.${DIFFNAME}-patch.1;;
      # Report an error if exit 2 or greater.
      *) echo "${RESULT_DIR}/${file}*$ERR"
         echo "${OUT}" > ${RESULT_DIR}/${file}.${DIFFNAME}-patch.$ERR;;
    esac
  else
    touch ${RESULT_DIR}/${file}.no-base;
  fi
done
